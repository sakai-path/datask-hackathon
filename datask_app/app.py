# =============================================================================
# app.py - ãŠã—ã‚ƒã¹ã‚Šãƒ‡ãƒ¼ã‚¿ï¼šè‡ªç„¶è¨€èªžã‹ã‚‰SQLâ†’å®Ÿè¡Œâ†’çµæžœã‚’å‡ºã—åˆ†ã‘
# -----------------------------------------------------------------------------
# ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€è‡ªç„¶è¨€èªžã®è³ªå•ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€
# - Azure OpenAI ã® Function Calling ã‚’ä½¿ã£ã¦ SQL ã‚’ç”Ÿæˆ
# - å®Ÿè¡Œã—ã¦è¡¨ï¼æ–‡ç« ï¼ã‚°ãƒ©ãƒ•ãªã©ã‚’è‡ªå‹•ã§è¡¨ç¤º
# -----------------------------------------------------------------------------
# å…¥åŠ›ï¼šè³ªå•æ–‡ï¼ˆä¾‹ï¼šã€Œç”°ä¸­ã•ã‚“ã®åˆ©ç”¨çŠ¶æ³ã¯ï¼Ÿã€ï¼‰
# å‡ºåŠ›ï¼šè³ªå•ã«å¿œã˜ãŸå¯è¦–åŒ–ï¼ˆè¡¨ã€æ–‡ç« ã€ã‚°ãƒ©ãƒ•ï¼‰
# =============================================================================

import streamlit as st
from core.db import run_query, engine
from core.openai_sql import generate_sql
from visual.charts import (
    get_monthly_usage_by_employee,
    draw_monthly_usage_chart,
    get_seat_usage_counts,
    draw_usage_bar_chart,
)

st.set_page_config(page_title="ãŠã—ã‚ƒã¹ã‚Šãƒ‡ãƒ¼ã‚¿", layout="centered")
st.title("ðŸ§  ãŠã—ã‚ƒã¹ã‚Šãƒ‡ãƒ¼ã‚¿")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¥åŠ›æ¬„ï¼šè³ªå•ãƒ†ã‚­ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ï¼ˆè‡ªç„¶è¨€èªžã®ã¿ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("#### è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Žç”°ä¸­ã•ã‚“ã®æœˆåˆ¥åˆ©ç”¨çŠ¶æ³ã¯ï¼Ÿã€ãªã©ï¼‰")

query = st.text_input("ä¾‹ï¼šã€Œç¾åœ¨ç©ºã„ã¦ã„ã‚‹å¸­ã¯ï¼Ÿã€", placeholder="ã“ã“ã«è³ªå•ã‚’å…¥åŠ›...")

# SQLè¡¨ç¤ºã®ãƒˆã‚°ãƒ«ç”¨
show_sql = st.checkbox("ç”Ÿæˆã•ã‚ŒãŸSQLã‚’è¡¨ç¤º", value=False)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¥åŠ›ã•ã‚ŒãŸè³ªå•ãŒã‚ã‚Œã°SQLç”Ÿæˆâ†’å®Ÿè¡Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if query:
    with st.spinner("AIãŒè³ªå•ã‚’è§£æžä¸­..."):
        sql = generate_sql(query)

    if not sql or not sql.strip().lower().startswith("select"):
        st.error("SQLç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
    else:
        if show_sql:
            st.code(sql, language="sql")

        try:
            df = run_query(sql)
        except Exception as e:
            st.error(f"SQLå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            df = None

        if df is not None:
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # å‡ºã—åˆ†ã‘å‡¦ç†ï¼šãƒ‡ãƒ¼ã‚¿å†…å®¹ã«å¿œã˜ã¦è¡¨ç¤ºå½¢å¼ã‚’åˆ¤æ–­
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            # 1. æ°åï¼‹æœˆï¼‹åˆ©ç”¨å›žæ•° â†’ ã‚°ãƒ©ãƒ•
            if set(df.columns) >= {"Month", "UsageCount"} and len(df) <= 24:
                draw_monthly_usage_chart(df)

            # 2. å¸­ãƒ©ãƒ™ãƒ«ï¼‹åˆ©ç”¨å›žæ•° â†’ åº§å¸­é›†è¨ˆã‚°ãƒ©ãƒ•
            elif set(df.columns) >= {"Label", "UsageCount"} and len(df) <= 100:
                draw_usage_bar_chart(df)

            # 3. çµæžœè¡Œæ•°ãŒå°‘ãªã„ â†’ ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯ãªããƒ†ã‚­ã‚¹ãƒˆçš„ã«å‡ºåŠ›
            elif len(df) == 1 and df.shape[1] == 1:
                st.success(f"å›žç­”ï¼š{df.iloc[0, 0]}")

            # 4. é€šå¸¸ã®è¡¨è¡¨ç¤º
            else:
                st.dataframe(df, use_container_width=True)



